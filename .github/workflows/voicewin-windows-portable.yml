name: VoiceWin Windows Portable

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-windows-portable:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on main
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main --depth=1
          if git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
            echo "Tag commit is reachable from main."
          else
            echo "ERROR: Tag commit is not reachable from main." >&2
            exit 1
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            voicewin-tauri/src-tauri -> voicewin-tauri/src-tauri/target

      - name: Install frontend dependencies
        working-directory: voicewin-tauri
        run: bun install

      - name: Frontend tests
        working-directory: voicewin-tauri
        run: bun run test

      - name: Rust workspace tests
        run: cargo test

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Build Tauri app (no bundle)
        working-directory: voicewin-tauri
        run: cargo tauri build --no-bundle

      - name: Assemble portable folder
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $project = Join-Path $env:GITHUB_WORKSPACE 'voicewin-tauri'
          $exeDir = Join-Path $project 'src-tauri/target/release'

          # Find the first exe in release that is not a build-script.
          $exe = Get-ChildItem -Path $exeDir -Filter *.exe | Where-Object { $_.Name -notmatch 'build-script' } | Select-Object -First 1
          if (-not $exe) {
            throw "No .exe found in $exeDir"
          }

          $outRoot = Join-Path $env:GITHUB_WORKSPACE 'portable/VoiceWin'
          New-Item -ItemType Directory -Force -Path $outRoot | Out-Null

          # Copy executable + adjacent DLLs (portable runtime bits).
          Copy-Item -Force $exe.FullName (Join-Path $outRoot 'VoiceWin.exe')
          Get-ChildItem -Path $exeDir -Filter *.dll | ForEach-Object { Copy-Item -Force $_.FullName $outRoot }

          # Copy bootstrap model in the expected relative location.
          $modelsDir = Join-Path $outRoot 'models'
          New-Item -ItemType Directory -Force -Path $modelsDir | Out-Null

          $bootstrap = Join-Path $project 'src-tauri/resources/models/bootstrap.gguf'
          if (-not (Test-Path $bootstrap)) {
            throw "Missing bootstrap model at $bootstrap"
          }
          Copy-Item -Force $bootstrap (Join-Path $modelsDir 'bootstrap.gguf')

          # Optional fallback path.
          $fallback = Join-Path $outRoot 'resources/models'
          New-Item -ItemType Directory -Force -Path $fallback | Out-Null
          Copy-Item -Force $bootstrap (Join-Path $fallback 'bootstrap.gguf')

          # Zip it (simple name).
          $zipPath = Join-Path $env:GITHUB_WORKSPACE 'VoiceWin-windows-portable.zip'
          if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
          Compress-Archive -Path (Join-Path $env:GITHUB_WORKSPACE 'portable/*') -DestinationPath $zipPath

      - name: Upload portable zip
        uses: actions/upload-artifact@v4
        with:
          name: VoiceWin-windows-portable
          path: VoiceWin-windows-portable.zip
          if-no-files-found: error
