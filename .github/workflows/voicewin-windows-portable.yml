name: VoiceWin Windows Installer

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-windows-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on main
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main --depth=1
          if git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
            echo "Tag commit is reachable from main."
          else
            echo "ERROR: Tag commit is not reachable from main." >&2
            exit 1
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            voicewin-tauri/src-tauri -> voicewin-tauri/src-tauri/target

      - name: Install frontend dependencies
        working-directory: voicewin-tauri
        run: bun install

      - name: Frontend tests
        working-directory: voicewin-tauri
        run: bun run test

      - name: Rust workspace tests
        run: cargo test

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Build Tauri app (NSIS installer)
        working-directory: voicewin-tauri
        run: cargo tauri build --target x86_64-pc-windows-msvc

      - name: Verify binary does not depend on VC++ runtime
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Tauri app binary name can vary; inspect the first release exe.
          $releaseDir = Join-Path $env:GITHUB_WORKSPACE 'voicewin-tauri/src-tauri/target/x86_64-pc-windows-msvc/release'
          $exe = Get-ChildItem -Path $releaseDir -Filter *.exe | Select-Object -First 1 | ForEach-Object { $_.FullName }
          if (-not $exe -or -not (Test-Path $exe)) {
            throw "Could not locate built executable under $releaseDir"
          }

          # Resolve dumpbin from the VS toolchain.
          # It is not always on PATH on GitHub-hosted runners unless a dev cmd is initialized.
          $dumpbin = (Get-Command dumpbin.exe -ErrorAction SilentlyContinue).Source
          if (-not $dumpbin) {
            $vswhere = Join-Path ${env:ProgramFiles(x86)} 'Microsoft Visual Studio\Installer\vswhere.exe'
            if (Test-Path $vswhere) {
              $dumpbin = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -find VC\Tools\MSVC\**\bin\Hostx64\x64\dumpbin.exe | Select-Object -First 1
            }
          }
          if (-not $dumpbin -or -not (Test-Path $dumpbin)) {
            throw 'dumpbin.exe not found (install Visual Studio C++ tools or run a VS dev cmd before this step)'
          }

          $deps = & $dumpbin /DEPENDENTS $exe 2>$null | Out-String
          if (-not $deps -or $deps.Trim().Length -eq 0) {
            throw 'dumpbin produced no output (tool missing?)'
          }
          if ($deps -match 'VCRUNTIME' -or $deps -match 'MSVCP') {
            Write-Host $deps
            throw 'Detected VC++ runtime dependency (VCRUNTIME/MSVCP).'
          }

      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: VoiceWin-windows-installer
          path: voicewin-tauri/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*-setup.exe
          if-no-files-found: error
